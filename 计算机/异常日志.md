# 2020-08-03

问题描述：`<form>` 中的 `<button>` 的 `onclick` 绑定了一个方法，该方法中用 JQuery 的 ajax 发起了一个 post 请求插入数据，执行之后请求没有发送到后台，直接进入 ajax error 方法，`jqXHR` 的 `readystate` 是 0，页面的地址变成了原地址后加上一个`?`。

问题原因：`<button>` 有三种类型 `submit` 、`reset` 、`button`，`type` 属性的默认值是 `submit`。所以，在未指定 `type` 的情况下，点击 `<button>` 会直接触发表单提交，但是表单又没有指定提交地址 `action` 的值，所以就刷新了本页面，出现了“页面的地址变成了原地址后加上一个`?`”的情况。提交表单，刷新本页的过程非常短，导致`onclick` 方法中的异步的 ajax 请求并没有完成发送、接收的整个过程，甚至还处在未发送创建连接的状态（`readystate=0`），所以导致请求没有发送到后台，进入了 ajax error。

解决方法：明确指定 `<button type="button">`

# 2020-12-24

问题描述：使用 RXTXcomm.jar 进行串口通信，调用 `CommPortIdentifier.getPortIdentifier(portName);` 出现 `java.lang.UnsatisfiedLinkError: no rxtxSerial in java.library.path`

问题原因：java lib 中缺少 **`rxtxSerial.dll`和`rxtxParallel.dll`** 

解决方法：从 [RXTX for Java](http://fizzed.com/oss/rxtx-for-java) 下载操作系统版本对应的 RXTX-2-2-20081207 ，得到 `mfz-rxtx-2.2-20081207-win-x64.zip` 文件，解压该文件，根据 `Install.txt` 文件中的说明，把 `rxtxSerial.dll`和`rxtxParallel.dll` 复制到 `<JAVA_HOME>\jre\bin` 中

# 2021-01-07

问题描述：通过usb连接串口设备，识别串口，设备管理器中 “其他设备” 出现 “ft232r usb uart”

问题原因：缺少驱动

解决方法：[下载 ft232r usb uart 驱动](https://forspeed.rbread05.cn/down/newdown/10/21/ft232r.rar) ，解压，`设备管理`中`其他设备 -> ft232r usb uart` 右键-> `更新驱动程序` -> `浏览我的电脑以查找驱动程序` -> `在以下位置搜索驱动程序`选择驱动解压的目录 -> `下一步`。 安装完成后重启系统，`设备管理器`出现`端口(COM和LPT)`，显示设备使用的端口。

# 2021-01-20

问题描述：mybatis-plus 查询 oracle 库表，执行查询方法出现以下异常： 

```
2021-01-20 11:38:52.643  INFO 59580 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Starting...
2021-01-20 11:38:53.098  INFO 59580 --- [           main] com.zaxxer.hikari.pool.PoolBase          : HikariPool-1 - Driver does not support get/set network timeout for connections. (oracle.jdbc.driver.T4CConnection.getNetworkTimeout()I)
2021-01-20 11:38:53.108  INFO 59580 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Start completed.
Exception in thread "main" java.lang.AbstractMethodError: Method oracle/jdbc/driver/OracleResultSetImpl.getObject(Ljava/lang/String;Ljava/lang/Class;)Ljava/lang/Object; is abstract
	at oracle.jdbc.driver.OracleResultSetImpl.getObject(OracleResultSetImpl.java)
	at com.zaxxer.hikari.pool.HikariProxyResultSet.getObject(HikariProxyResultSet.java)
	at org.apache.ibatis.type.LocalDateTimeTypeHandler.getNullableResult(LocalDateTimeTypeHandler.java:38)
	at org.apache.ibatis.type.LocalDateTimeTypeHandler.getNullableResult(LocalDateTimeTypeHandler.java:28)
	at org.apache.ibatis.type.BaseTypeHandler.getResult(BaseTypeHandler.java:85)
	at org.apache.ibatis.executor.resultset.DefaultResultSetHandler.applyAutomaticMappings(DefaultResultSetHandler.java:560)
	at org.apache.ibatis.executor.resultset.DefaultResultSetHandler.getRowValue(DefaultResultSetHandler.java:402)
	at org.apache.ibatis.executor.resultset.DefaultResultSetHandler.handleRowValuesForSimpleResultMap(DefaultResultSetHandler.java:354)
	at org.apache.ibatis.executor.resultset.DefaultResultSetHandler.handleRowValues(DefaultResultSetHandler.java:328)
	at org.apache.ibatis.executor.resultset.DefaultResultSetHandler.handleResultSet(DefaultResultSetHandler.java:301)
	at org.apache.ibatis.executor.resultset.DefaultResultSetHandler.handleResultSets(DefaultResultSetHandler.java:194)
	at org.apache.ibatis.executor.statement.PreparedStatementHandler.query(PreparedStatementHandler.java:65)
	at org.apache.ibatis.executor.statement.RoutingStatementHandler.query(RoutingStatementHandler.java:79)
	at com.baomidou.mybatisplus.core.executor.MybatisSimpleExecutor.doQuery(MybatisSimpleExecutor.java:69)
	at org.apache.ibatis.executor.BaseExecutor.queryFromDatabase(BaseExecutor.java:325)
	at org.apache.ibatis.executor.BaseExecutor.query(BaseExecutor.java:156)
	at com.baomidou.mybatisplus.core.executor.MybatisCachingExecutor.query(MybatisCachingExecutor.java:165)
	at com.baomidou.mybatisplus.core.executor.MybatisCachingExecutor.query(MybatisCachingExecutor.java:92)
	at org.apache.ibatis.session.defaults.DefaultSqlSession.selectList(DefaultSqlSession.java:147)
	at org.apache.ibatis.session.defaults.DefaultSqlSession.selectList(DefaultSqlSession.java:140)
	at org.apache.ibatis.session.defaults.DefaultSqlSession.selectOne(DefaultSqlSession.java:76)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:426)
	at com.sun.proxy.$Proxy61.selectOne(Unknown Source)
	at org.mybatis.spring.SqlSessionTemplate.selectOne(SqlSessionTemplate.java:159)
	at com.baomidou.mybatisplus.core.override.MybatisMapperMethod.execute(MybatisMapperMethod.java:90)
	at com.baomidou.mybatisplus.core.override.MybatisMapperProxy$PlainMethodInvoker.invoke(MybatisMapperProxy.java:148)
	at com.baomidou.mybatisplus.core.override.MybatisMapperProxy.invoke(MybatisMapperProxy.java:89)
	at com.sun.proxy.$Proxy64.selectById(Unknown Source)
	at org.fcx.dbhelper.DbHelperApp.main(DbHelperApp.java:39)
```

依赖信息:

```xml
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-boot-starter</artifactId>
    <version>3.4.2</version>
</dependency>
<dependency>
    <groupId>com.oracle.database.jdbc</groupId>
    <artifactId>ojdbc6</artifactId>
    <version>11.2.0.4</version>
</dependency>
```

代码：

```java
@SpringBootApplication
@MapperScan("com.hzwq.tool.dao")
public class DbHelperApp {
    public static void main( String[] args ){
        ConfigurableApplicationContext ac = SpringApplication.run(DbHelperApp.class, args);
        SysDataitemPcMapper mapper = ac.getBean(SysDataitemPcMapper.class);
        SysDataitemPc item = mapper.selectById("697");
        log.info(item.toString());
    }
}
```

问题原因：

> [参考资料](https://blog.csdn.net/weixin_42213903/article/details/103188639)

mybatis 高版本的包与 oracle ojdbc6 冲突，mybatis-plus 3.4.2，依赖的是 mybatis 3.5.6

解决方法：

降低 mybatis-plus 版本到 3.1.0，mybatis-plus 3.1.0 里面使用的mybati 3.5.0 可以正常运行。



# 2021-04-21

问题描述：

orderM 1.7.7，修改 datahub 版本为 1.50，启动失败，出现以下错误：

```
Caused by: javax.validation.UnexpectedTypeException: HV000030: No validator could be found for constraint 'javax.validation.constraints.NotEmpty' validating type 'java.lang.String'. Check configuration for 'defaultContext'
	at org.hibernate.validator.internal.engine.constraintvalidation.ConstraintTree.throwExceptionForNullValidator(ConstraintTree.java:229)
	at org.hibernate.validator.internal.engine.constraintvalidation.ConstraintTree.getConstraintValidatorNoUnwrapping(ConstraintTree.java:310)
	at org.hibernate.validator.internal.engine.constraintvalidation.ConstraintTree.getConstraintValidatorInstanceForAutomaticUnwrapping(ConstraintTree.java:244)
	at org.hibernate.validator.internal.engine.constraintvalidation.ConstraintTree.getInitializedConstraintValidator(ConstraintTree.java:163)
	at org.hibernate.validator.internal.engine.constraintvalidation.ConstraintTree.validateConstraints(ConstraintTree.java:116)
	at org.hibernate.validator.internal.engine.constraintvalidation.ConstraintTree.validateConstraints(ConstraintTree.java:87)
	at org.hibernate.validator.internal.metadata.core.MetaConstraint.validateConstraint(MetaConstraint.java:73)
	at org.hibernate.validator.internal.engine.ValidatorImpl.validateMetaConstraint(ValidatorImpl.java:621)
	at org.hibernate.validator.internal.engine.ValidatorImpl.validateConstraint(ValidatorImpl.java:584)
	at org.hibernate.validator.internal.engine.ValidatorImpl.validateConstraintsForSingleDefaultGroupElement(ValidatorImpl.java:528)
	at org.hibernate.validator.internal.engine.ValidatorImpl.validateConstraintsForDefaultGroup(ValidatorImpl.java:496)
	at org.hibernate.validator.internal.engine.ValidatorImpl.validateConstraintsForCurrentGroup(ValidatorImpl.java:461)
	at org.hibernate.validator.internal.engine.ValidatorImpl.validateInContext(ValidatorImpl.java:411)
	at org.hibernate.validator.internal.engine.ValidatorImpl.validate(ValidatorImpl.java:208)
	at org.springframework.validation.beanvalidation.SpringValidatorAdapter.validate(SpringValidatorAdapter.java:102)
	at org.springframework.validation.DataBinder.validate(DataBinder.java:877)
	at org.springframework.boot.bind.PropertiesConfigurationFactory.doBindPropertiesToTarget(PropertiesConfigurationFactory.java:274)
	at org.springframework.boot.bind.PropertiesConfigurationFactory.bindPropertiesToTarget(PropertiesConfigurationFactory.java:240)
	at org.springframework.boot.context.properties.ConfigurationPropertiesBindingPostProcessor.postProcessBeforeInitialization(ConfigurationPropertiesBindingPostProcessor.java:330)
	... 64 common frames omitted
```



问题原因：

> [参考资料](https://www.cnblogs.com/softidea/p/6044123.html)

validation-api 版本和 hibernate-validator 版本不匹配，spring-boot-starter-web:jar:1.5.10.RELEASE 中使用的是 hibernate-validator:jar:5.3.6.Final，对应 validation-api:jar:1.1.0.Final，而 eom-datahub:jar:1.50 使用了 validation-api:jar:2.0.2 但没有配套的 hibernate-validator 。

```
[INFO] +- org.springframework.boot:spring-boot-starter-web:jar:1.5.10.RELEASE:compile
[INFO] |  +- org.springframework.boot:spring-boot-starter-tomcat:jar:1.5.10.RELEASE:compile
[INFO] |  |  +- org.apache.tomcat.embed:tomcat-embed-core:jar:8.5.57:compile
[INFO] |  |  |  \- org.apache.tomcat:tomcat-annotations-api:jar:8.5.57:compile
[INFO] |  |  +- org.apache.tomcat.embed:tomcat-embed-el:jar:8.5.57:compile
[INFO] |  |  \- org.apache.tomcat.embed:tomcat-embed-websocket:jar:8.5.57:compile
[INFO] |  +- org.hibernate:hibernate-validator:jar:5.3.6.Final:compile
[INFO] |  |  +- javax.validation:validation-api:jar:1.1.0.Final:compile
[INFO] |  |  +- org.jboss.logging:jboss-logging:jar:3.3.1.Final:compile
[INFO] |  |  \- com.fasterxml:classmate:jar:1.3.4:compile
[INFO] |  +- org.springframework:spring-web:jar:4.3.14.RELEASE:compile
[INFO] |  |  \- org.springframework:spring-beans:jar:4.3.14.RELEASE:compile
[INFO] |  \- org.springframework:spring-webmvc:jar:4.3.14.RELEASE:compile
[INFO] |     \- org.springframework:spring-expression:jar:4.3.14.RELEASE:compile
...
[INFO] +- eom.datahub:eom-datahub:jar:1.50:compile
[INFO] |  +- com.hzwq.starter:hzwq-spring-boot-starter-redis:jar:2.1.1:compile
[INFO] |  |  +- org.springframework.boot:spring-boot-starter-cache:jar:1.5.10.RELEASE:compile
[INFO] |  |  +- org.springframework.boot:spring-boot-configuration-processor:jar:1.5.10.RELEASE:compile
[INFO] |  |  +- com.hzwq.starter:hzwq-spring-boot-starter-util:jar:2.1.1:compile
[INFO] |  |  \- jakarta.validation:jakarta.validation-api:jar:2.0.2:compile
[INFO] |  \- com.hzwq.starter:hzwq-rocketmq:jar:2.1.0:compile
```



解决方法：

pom中添加适配的 hibernate-validator 依赖

```
<dependency>
    <groupId>org.hibernate.validator</groupId>
    <artifactId>hibernate-validator</artifactId>
    <version>6.1.7.Final</version>
</dependency>
```



# 2021-08-02

问题描述：程序在idea中启动运行正常，使用 spring-boot-maven-plugin 打成可执行 jar 之后启动报错，错误信息如下：

```
[ ERROR] [2021-08-02 17:51:20] [main] org.springframework.boot.SpringApplication - [reportFailure,823] -Application run failed
org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'frameData698Controller': Injection of resource dependencies failed; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'frame698ServiceImpl': Injection of resource dependencies failed; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'meterFrameMapper' defined in URL [jar:file:/G:/HZWQ/projects/frameDataServer/target/frameDataServer.jar!/BOOT-INF/classes!/com/hzwq/micro/frame/mapper/MeterFrameMapper.class]: Cannot resolve reference to bean 'frameDataSqlSessionFactory' while setting bean property 'sqlSessionFactory'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'frameDataSqlSessionFactory' defined in class path resource [com/hzwq/micro/frame/config/FrameDataSqlSessionFactoryConfiguration.class]: Bean instantiation via factory method failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [org.apache.ibatis.session.SqlSessionFactory]: Factory method 'createSqlSessionFactoryBean' threw exception; nested exception is org.springframework.core.NestedIOException: Failed to parse mapping resource: 'URL [jar:file:/G:/HZWQ/projects/frameDataServer/target/frameDataServer.jar!/BOOT-INF/classes!/mybatis/frame/mapper/FrameData645Mapper.xml]'; nested exception is org.apache.ibatis.builder.BuilderException: Error parsing Mapper XML. Cause: org.apache.ibatis.builder.BuilderException: Error resolving class. Cause: org.apache.ibatis.type.TypeException: Could not resolve type alias 'DataItem645Param'.  Cause: java.lang.ClassNotFoundException: Cannot find class: DataItem645Param
	at org.springframework.context.annotation.CommonAnnotationBeanPostProcessor.postProcessProperties(CommonAnnotationBeanPostProcessor.java:325)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.populateBean(AbstractAutowireCapableBeanFactory.java:1402)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:591)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:514)
	at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:321)
	at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:234)
	at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:319)
	at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:199)
	at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:866)
	at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:878)
	at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:550)
	at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.refresh(ServletWebServerApplicationContext.java:141)
	at org.springframework.boot.SpringApplication.refresh(SpringApplication.java:744)
	at org.springframework.boot.SpringApplication.refreshContext(SpringApplication.java:391)
	at org.springframework.boot.SpringApplication.run(SpringApplication.java:312)
	at org.springframework.boot.SpringApplication.run(SpringApplication.java:1215)
	at org.springframework.boot.SpringApplication.run(SpringApplication.java:1204)
	at com.hzwq.micro.FrameDataServerApplication.main(FrameDataServerApplication.java:24)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.springframework.boot.loader.MainMethodRunner.run(MainMethodRunner.java:48)
	at org.springframework.boot.loader.Launcher.launch(Launcher.java:87)
	at org.springframework.boot.loader.Launcher.launch(Launcher.java:51)
	at org.springframework.boot.loader.JarLauncher.main(JarLauncher.java:52)
Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'frame698ServiceImpl': Injection of resource dependencies failed; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'meterFrameMapper' defined in URL [jar:file:/G:/HZWQ/projects/frameDataServer/target/frameDataServer.jar!/BOOT-INF/classes!/com/hzwq/micro/frame/mapper/MeterFrameMapper.class]: Cannot resolve reference to bean 'frameDataSqlSessionFactory' while setting bean property 'sqlSessionFactory'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'frameDataSqlSessionFactory' defined in class path resource [com/hzwq/micro/frame/config/FrameDataSqlSessionFactoryConfiguration.class]: Bean instantiation via factory method failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [org.apache.ibatis.session.SqlSessionFactory]: Factory method 'createSqlSessionFactoryBean' threw exception; nested exception is org.springframework.core.NestedIOException: Failed to parse mapping resource: 'URL [jar:file:/G:/HZWQ/projects/frameDataServer/target/frameDataServer.jar!/BOOT-INF/classes!/mybatis/frame/mapper/FrameData645Mapper.xml]'; nested exception is org.apache.ibatis.builder.BuilderException: Error parsing Mapper XML. Cause: org.apache.ibatis.builder.BuilderException: Error resolving class. Cause: org.apache.ibatis.type.TypeException: Could not resolve type alias 'DataItem645Param'.  Cause: java.lang.ClassNotFoundException: Cannot find class: DataItem645Param
	at org.springframework.context.annotation.CommonAnnotationBeanPostProcessor.postProcessProperties(CommonAnnotationBeanPostProcessor.java:325)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.populateBean(AbstractAutowireCapableBeanFactory.java:1402)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:591)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:514)
	at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:321)
	at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:234)
	at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:319)
	at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:199)
	at org.springframework.beans.factory.config.DependencyDescriptor.resolveCandidate(DependencyDescriptor.java:277)
	at org.springframework.beans.factory.support.DefaultListableBeanFactory.doResolveDependency(DefaultListableBeanFactory.java:1276)
	at org.springframework.beans.factory.support.DefaultListableBeanFactory.resolveDependency(DefaultListableBeanFactory.java:1196)
	at org.springframework.context.annotation.CommonAnnotationBeanPostProcessor.autowireResource(CommonAnnotationBeanPostProcessor.java:521)
	at org.springframework.context.annotation.CommonAnnotationBeanPostProcessor.getResource(CommonAnnotationBeanPostProcessor.java:497)
	at org.springframework.context.annotation.CommonAnnotationBeanPostProcessor$ResourceElement.getResourceToInject(CommonAnnotationBeanPostProcessor.java:637)
	at org.springframework.beans.factory.annotation.InjectionMetadata$InjectedElement.inject(InjectionMetadata.java:180)
	at org.springframework.beans.factory.annotation.InjectionMetadata.inject(InjectionMetadata.java:90)
	at org.springframework.context.annotation.CommonAnnotationBeanPostProcessor.postProcessProperties(CommonAnnotationBeanPostProcessor.java:322)
	... 25 common frames omitted
Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'meterFrameMapper' defined in URL [jar:file:/G:/HZWQ/projects/frameDataServer/target/frameDataServer.jar!/BOOT-INF/classes!/com/hzwq/micro/frame/mapper/MeterFrameMapper.class]: Cannot resolve reference to bean 'frameDataSqlSessionFactory' while setting bean property 'sqlSessionFactory'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'frameDataSqlSessionFactory' defined in class path resource [com/hzwq/micro/frame/config/FrameDataSqlSessionFactoryConfiguration.class]: Bean instantiation via factory method failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [org.apache.ibatis.session.SqlSessionFactory]: Factory method 'createSqlSessionFactoryBean' threw exception; nested exception is org.springframework.core.NestedIOException: Failed to parse mapping resource: 'URL [jar:file:/G:/HZWQ/projects/frameDataServer/target/frameDataServer.jar!/BOOT-INF/classes!/mybatis/frame/mapper/FrameData645Mapper.xml]'; nested exception is org.apache.ibatis.builder.BuilderException: Error parsing Mapper XML. Cause: org.apache.ibatis.builder.BuilderException: Error resolving class. Cause: org.apache.ibatis.type.TypeException: Could not resolve type alias 'DataItem645Param'.  Cause: java.lang.ClassNotFoundException: Cannot find class: DataItem645Param
	at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveReference(BeanDefinitionValueResolver.java:314)
	at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveValueIfNecessary(BeanDefinitionValueResolver.java:110)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.applyPropertyValues(AbstractAutowireCapableBeanFactory.java:1672)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.populateBean(AbstractAutowireCapableBeanFactory.java:1424)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:591)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:514)
	at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:321)
	at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:234)
	at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:319)
	at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:204)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.resolveBeanByName(AbstractAutowireCapableBeanFactory.java:451)
	at org.springframework.context.annotation.CommonAnnotationBeanPostProcessor.autowireResource(CommonAnnotationBeanPostProcessor.java:527)
	at org.springframework.context.annotation.CommonAnnotationBeanPostProcessor.getResource(CommonAnnotationBeanPostProcessor.java:497)
	at org.springframework.context.annotation.CommonAnnotationBeanPostProcessor$ResourceElement.getResourceToInject(CommonAnnotationBeanPostProcessor.java:637)
	at org.springframework.beans.factory.annotation.InjectionMetadata$InjectedElement.inject(InjectionMetadata.java:180)
	at org.springframework.beans.factory.annotation.InjectionMetadata.inject(InjectionMetadata.java:90)
	at org.springframework.context.annotation.CommonAnnotationBeanPostProcessor.postProcessProperties(CommonAnnotationBeanPostProcessor.java:322)
	... 41 common frames omitted
Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'frameDataSqlSessionFactory' defined in class path resource [com/hzwq/micro/frame/config/FrameDataSqlSessionFactoryConfiguration.class]: Bean instantiation via factory method failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [org.apache.ibatis.session.SqlSessionFactory]: Factory method 'createSqlSessionFactoryBean' threw exception; nested exception is org.springframework.core.NestedIOException: Failed to parse mapping resource: 'URL [jar:file:/G:/HZWQ/projects/frameDataServer/target/frameDataServer.jar!/BOOT-INF/classes!/mybatis/frame/mapper/FrameData645Mapper.xml]'; nested exception is org.apache.ibatis.builder.BuilderException: Error parsing Mapper XML. Cause: org.apache.ibatis.builder.BuilderException: Error resolving class. Cause: org.apache.ibatis.type.TypeException: Could not resolve type alias 'DataItem645Param'.  Cause: java.lang.ClassNotFoundException: Cannot find class: DataItem645Param
	at org.springframework.beans.factory.support.ConstructorResolver.instantiate(ConstructorResolver.java:627)
	at org.springframework.beans.factory.support.ConstructorResolver.instantiateUsingFactoryMethod(ConstructorResolver.java:607)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.instantiateUsingFactoryMethod(AbstractAutowireCapableBeanFactory.java:1318)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBeanInstance(AbstractAutowireCapableBeanFactory.java:1158)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:554)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:514)
	at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:321)
	at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:234)
	at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:319)
	at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:199)
	at org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveReference(BeanDefinitionValueResolver.java:303)
	... 57 common frames omitted
Caused by: org.springframework.beans.BeanInstantiationException: Failed to instantiate [org.apache.ibatis.session.SqlSessionFactory]: Factory method 'createSqlSessionFactoryBean' threw exception; nested exception is org.springframework.core.NestedIOException: Failed to parse mapping resource: 'URL [jar:file:/G:/HZWQ/projects/frameDataServer/target/frameDataServer.jar!/BOOT-INF/classes!/mybatis/frame/mapper/FrameData645Mapper.xml]'; nested exception is org.apache.ibatis.builder.BuilderException: Error parsing Mapper XML. Cause: org.apache.ibatis.builder.BuilderException: Error resolving class. Cause: org.apache.ibatis.type.TypeException: Could not resolve type alias 'DataItem645Param'.  Cause: java.lang.ClassNotFoundException: Cannot find class: DataItem645Param
	at org.springframework.beans.factory.support.SimpleInstantiationStrategy.instantiate(SimpleInstantiationStrategy.java:185)
	at org.springframework.beans.factory.support.ConstructorResolver.instantiate(ConstructorResolver.java:622)
	... 67 common frames omitted
Caused by: org.springframework.core.NestedIOException: Failed to parse mapping resource: 'URL [jar:file:/G:/HZWQ/projects/frameDataServer/target/frameDataServer.jar!/BOOT-INF/classes!/mybatis/frame/mapper/FrameData645Mapper.xml]'; nested exception is org.apache.ibatis.builder.BuilderException: Error parsing Mapper XML. Cause: org.apache.ibatis.builder.BuilderException: Error resolving class. Cause: org.apache.ibatis.type.TypeException: Could not resolve type alias 'DataItem645Param'.  Cause: java.lang.ClassNotFoundException: Cannot find class: DataItem645Param
	at org.mybatis.spring.SqlSessionFactoryBean.buildSqlSessionFactory(SqlSessionFactoryBean.java:523)
	at org.mybatis.spring.SqlSessionFactoryBean.afterPropertiesSet(SqlSessionFactoryBean.java:380)
	at org.mybatis.spring.SqlSessionFactoryBean.getObject(SqlSessionFactoryBean.java:547)
	at com.hzwq.micro.frame.config.FrameDataSqlSessionFactoryConfiguration.createSqlSessionFactoryBean(FrameDataSqlSessionFactoryConfiguration.java:75)
	at com.hzwq.micro.frame.config.FrameDataSqlSessionFactoryConfiguration$$EnhancerBySpringCGLIB$$58f44e44.CGLIB$createSqlSessionFactoryBean$1(<generated>)
	at com.hzwq.micro.frame.config.FrameDataSqlSessionFactoryConfiguration$$EnhancerBySpringCGLIB$$58f44e44$$FastClassBySpringCGLIB$$5794a93c.invoke(<generated>)
	at org.springframework.cglib.proxy.MethodProxy.invokeSuper(MethodProxy.java:244)
	at org.springframework.context.annotation.ConfigurationClassEnhancer$BeanMethodInterceptor.intercept(ConfigurationClassEnhancer.java:363)
	at com.hzwq.micro.frame.config.FrameDataSqlSessionFactoryConfiguration$$EnhancerBySpringCGLIB$$58f44e44.createSqlSessionFactoryBean(<generated>)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.springframework.beans.factory.support.SimpleInstantiationStrategy.instantiate(SimpleInstantiationStrategy.java:154)
	... 68 common frames omitted
Caused by: org.apache.ibatis.builder.BuilderException: Error parsing Mapper XML. Cause: org.apache.ibatis.builder.BuilderException: Error resolving class. Cause: org.apache.ibatis.type.TypeException: Could not resolve type alias 'DataItem645Param'.  Cause: java.lang.ClassNotFoundException: Cannot find class: DataItem645Param
	at org.apache.ibatis.builder.xml.XMLMapperBuilder.configurationElement(XMLMapperBuilder.java:120)
	at org.apache.ibatis.builder.xml.XMLMapperBuilder.parse(XMLMapperBuilder.java:92)
	at org.mybatis.spring.SqlSessionFactoryBean.buildSqlSessionFactory(SqlSessionFactoryBean.java:521)
	... 81 common frames omitted
Caused by: org.apache.ibatis.builder.BuilderException: Error resolving class. Cause: org.apache.ibatis.type.TypeException: Could not resolve type alias 'DataItem645Param'.  Cause: java.lang.ClassNotFoundException: Cannot find class: DataItem645Param
	at org.apache.ibatis.builder.BaseBuilder.resolveClass(BaseBuilder.java:118)
	at org.apache.ibatis.builder.xml.XMLStatementBuilder.parseStatementNode(XMLStatementBuilder.java:68)
	at org.apache.ibatis.builder.xml.XMLMapperBuilder.buildStatementFromContext(XMLMapperBuilder.java:135)
	at org.apache.ibatis.builder.xml.XMLMapperBuilder.buildStatementFromContext(XMLMapperBuilder.java:128)
	at org.apache.ibatis.builder.xml.XMLMapperBuilder.configurationElement(XMLMapperBuilder.java:118)
	... 83 common frames omitted
Caused by: org.apache.ibatis.type.TypeException: Could not resolve type alias 'DataItem645Param'.  Cause: java.lang.ClassNotFoundException: Cannot find class: DataItem645Param
	at org.apache.ibatis.type.TypeAliasRegistry.resolveAlias(TypeAliasRegistry.java:120)
	at org.apache.ibatis.builder.BaseBuilder.resolveAlias(BaseBuilder.java:149)
	at org.apache.ibatis.builder.BaseBuilder.resolveClass(BaseBuilder.java:116)
	... 87 common frames omitted
Caused by: java.lang.ClassNotFoundException: Cannot find class: DataItem645Param
	at org.apache.ibatis.io.ClassLoaderWrapper.classForName(ClassLoaderWrapper.java:200)
	at org.apache.ibatis.io.ClassLoaderWrapper.classForName(ClassLoaderWrapper.java:89)
	at org.apache.ibatis.io.Resources.classForName(Resources.java:261)
	at org.apache.ibatis.type.TypeAliasRegistry.resolveAlias(TypeAliasRegistry.java:116)
	... 89 common frames omitted
```



问题原因：spring boot jar 包中 mybatis config 别名失效

> 参考资料
>
> [MyBatis无法扫描Spring Boot别名的Bug_rainbow702的博客-CSDN博客](https://blog.csdn.net/rainbow702/article/details/63255736)

解决方法：`SqlSessionFactory`

 的 bean 定义中 添加 `sqlSessionFactory.setVfs(SpringBootVFS.class);`

```java
@Bean(name = "frameDataSqlSessionFactory")
@Primary
public SqlSessionFactory createSqlSessionFactoryBean(@Qualifier("frameDataDatabaseIdProvider")DatabaseIdProvider databaseIdProvider) throws Exception {
    SqlSessionFactoryBean bean = new SqlSessionFactoryBean();
    /** 设置datasource */
    bean.setDataSource(getDatasource());
    String configLocation ="classpath:mybatis/frame/mybatis-config.xml";
    bean.setConfigLocation(new DefaultResourceLoader().getResource(configLocation));
    bean.setDatabaseIdProvider(databaseIdProvider);
    /** 设置typeAlias 包扫描路径 */
    PathMatchingResourcePatternResolver resolver = new PathMatchingResourcePatternResolver();
    bean.setMapperLocations(resolver.getResources("classpath*:/mybatis/frame/mapper/*.xml"));

    // 解决 jar 包 中 mybatis-config typeAliases package 失效
    bean.setVfs(SpringBootVFS.class);
    return bean.getObject();
}
```



# 2021-10-18

> [tomcat启动报错：Invalid byte tag in constant pool: 19](https://blog.csdn.net/kinder10314/article/details/86629992)

问题描述：使用tomcat 9.0.0.M1 部署 machineServer， String boot web项目（使用外置servlet容器，主版本2.1.17.RELEAS）时，项目启动成功，但是启动过程中出现如下异常信息：

```
20-Jan-2022 11:33:01.480 SEVERE [localhost-startStop-1] org.apache.catalina.startup.ContextConfig.processAnnotationsJar Unable to process Jar entry [META-INF/versions/9/module-info.class] from Jar [jar:file:/F:/HZWQ/maven/repository/net/bytebuddy/byte-buddy/1.9.16/byte-buddy-1.9.16.jar!/] for annotations
 org.apache.tomcat.util.bcel.classfile.ClassFormatException: Invalid byte tag in constant pool: 19
	at org.apache.tomcat.util.bcel.classfile.Constant.readConstant(Constant.java:97)
	at org.apache.tomcat.util.bcel.classfile.ConstantPool.<init>(ConstantPool.java:55)
	at org.apache.tomcat.util.bcel.classfile.ClassParser.readConstantPool(ClassParser.java:176)
	at org.apache.tomcat.util.bcel.classfile.ClassParser.parse(ClassParser.java:85)
	at org.apache.catalina.startup.ContextConfig.processAnnotationsStream(ContextConfig.java:2042)
	at org.apache.catalina.startup.ContextConfig.processAnnotationsJar(ContextConfig.java:1992)
	at org.apache.catalina.startup.ContextConfig.processAnnotationsUrl(ContextConfig.java:1967)
	at org.apache.catalina.startup.ContextConfig.processAnnotations(ContextConfig.java:1928)
	at org.apache.catalina.startup.ContextConfig.webConfig(ContextConfig.java:1180)
	at org.apache.catalina.startup.ContextConfig.configureStart(ContextConfig.java:801)
	at org.apache.catalina.startup.ContextConfig.lifecycleEvent(ContextConfig.java:310)
	at org.apache.catalina.util.LifecycleBase.fireLifecycleEvent(LifecycleBase.java:94)
	at org.apache.catalina.core.StandardContext.startInternal(StandardContext.java:5095)
	at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:155)
	at org.apache.catalina.core.ContainerBase$StartChild.call(ContainerBase.java:1404)
	at org.apache.catalina.core.ContainerBase$StartChild.call(ContainerBase.java:1394)
	at java.util.concurrent.FutureTask.run$$$capture(FutureTask.java:266)
	at java.util.concurrent.FutureTask.run(FutureTask.java)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.Thread.run(Thread.java:748)
```



问题原因：项目引入了 springfox-swagger2-2.9.2，其内部依赖了 byte-buddy-1.9.16.jar，包中有 `META-INF/versions/9/module-info.class`文，该tomcat的版本不支持解析 `module-info.class` 文件。

> 注：spring-boot-starter-test 依赖的 Mockito 中也会使用该jar包，但因为 spring-boot-starter-test 一开始设置的 scope 就是 test，该问题并非由 spring-boot-starter-test 引起。

解决方法：

1. 升级tomcat到兼容 jdk9 module-info.class 的版本，升级 9.0.54 后该问题解决。（推荐方案）

2. swagger 非生产必须功能，maven依赖的 scope 设为 provided

   ```xml
   		<dependency>
   			<groupId>io.springfox</groupId>
   			<artifactId>springfox-swagger2</artifactId>
   			<version>2.9.2</version>
               <scope>provided</scope>
   		</dependency>
   		<dependency>
   			<groupId>io.springfox</groupId>
   			<artifactId>springfox-swagger-ui</artifactId>
   			<version>2.9.2</version>
               <scope>provided</scope>
   		</dependency>
   ```

   

# 2022-01-10

问题描述：machine服务，启动成功，但是调用so库方法后，加载so失败，异常信息如下：

```
java.lang.reflect.InvocationTargetException
	at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
	at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)
	at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
	at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
	at com.hzwq.mss.common.reflaction.NewesamRelaction.<clinit>(NewesamRelaction.java:18)
	at com.hzwq.mss.common.reflaction.Reflection.init(Reflection.java:84)
	at com.hzwq.mss.common.reflaction.Reflection.getResultWithParams(Reflection.java:49)
	at com.hzwq.mss.common.servlet.MechineServlet.doPost(MechineServlet.java:73)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:727)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:820)
	at weblogic.servlet.internal.StubSecurityHelper$ServletServiceAction.run(StubSecurityHelper.java:227)
	at weblogic.servlet.internal.StubSecurityHelper.invokeServlet(StubSecurityHelper.java:125)
	at weblogic.servlet.internal.ServletStubImpl.execute(ServletStubImpl.java:301)
	at weblogic.servlet.internal.ServletStubImpl.execute(ServletStubImpl.java:184)
	at weblogic.servlet.internal.WebAppServletContext$ServletInvocationAction.wrapRun(WebAppServletContext.java:3750)
	at weblogic.servlet.internal.WebAppServletContext$ServletInvocationAction.run(WebAppServletContext.java:3714)
	at weblogic.security.acl.internal.AuthenticatedSubject.doAs(AuthenticatedSubject.java:321)
	at weblogic.security.service.SecurityManager.runAs(SecurityManager.java:120)
	at weblogic.servlet.internal.WebAppServletContext.securedExecute(WebAppServletContext.java:2283)
	at weblogic.servlet.internal.WebAppServletContext.execute(WebAppServletContext.java:2182)
	at weblogic.servlet.internal.ServletRequestImpl.run(ServletRequestImpl.java:1493)
	at weblogic.work.ExecuteThread.execute(ExecuteThread.java:263)
	at weblogic.work.ExecuteThread.run(ExecuteThread.java:221)
Caused by: java.lang.Error: Failed to create temporary file for jnidispatch library: java.io.IOException: No such file or directory
	at com.sun.jna.Native.loadNativeLibraryFromJar(Native.java:747)
	at com.sun.jna.Native.loadNativeLibrary(Native.java:681)
	at com.sun.jna.Native.<clinit>(Native.java:109)
	at com.hzwq.mss.common.machine.newesam.EncryptionMachineNewesam.<init>(EncryptionMachineNewesam.java:39)
	at com.hzwq.mss.common.machine.newesam.EncryptionMachineNewesam.getInstance(EncryptionMachineNewesam.java:23)
	at com.hzwq.mss.common.machine.newesam.GetEncryptionMachineNewesam.<init>(GetEncryptionMachineNewesam.java:22)
	... 23 more
java.lang.NullPointerException
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at com.hzwq.mss.common.reflaction.Reflection.getResultWithParams(Reflection.java:61)
	at com.hzwq.mss.common.servlet.MechineServlet.doPost(MechineServlet.java:73)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:727)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:820)
	at weblogic.servlet.internal.StubSecurityHelper$ServletServiceAction.run(StubSecurityHelper.java:227)
	at weblogic.servlet.internal.StubSecurityHelper.invokeServlet(StubSecurityHelper.java:125)
	at weblogic.servlet.internal.ServletStubImpl.execute(ServletStubImpl.java:301)
	at weblogic.servlet.internal.ServletStubImpl.execute(ServletStubImpl.java:184)
	at weblogic.servlet.internal.WebAppServletContext$ServletInvocationAction.wrapRun(WebAppServletContext.java:3750)
	at weblogic.servlet.internal.WebAppServletContext$ServletInvocationAction.run(WebAppServletContext.java:3714)
	at weblogic.security.acl.internal.AuthenticatedSubject.doAs(AuthenticatedSubject.java:321)
	at weblogic.security.service.SecurityManager.runAs(SecurityManager.java:120)
	at weblogic.servlet.internal.WebAppServletContext.securedExecute(WebAppServletContext.java:2283)
	at weblogic.servlet.internal.WebAppServletContext.execute(WebAppServletContext.java:2182)
	at weblogic.servlet.internal.ServletRequestImpl.run(ServletRequestImpl.java:1493)
	at weblogic.work.ExecuteThread.execute(ExecuteThread.java:263)
	at weblogic.work.ExecuteThread.run(ExecuteThread.java:221)
```



问题原因：使用jna调用so库时，会在java进程的临时目录下生成jna的tmp文件，使用 `jinfo <pid> | grep java.io.tmpdir` 命令查看临时文件目录，发现 servlet 容器使用的临时目录不存在，导致 jna执行过程中抛出 `java.lang.Error: Failed to create temporary file for jnidispatch library: java.io.IOException: No such file or directory` 异常信息，so无法正常加载。服务启动过程中的java代码执行时，并不需要使用 `java.io.tmpdir` 所指定的目录，所以服务可正常启动并接收到请求。

> 1. machine服务中所有的so封装方法的调用均使用反射实现，反射虽然功能强大编码方便，但是后期问题排查时，异常信息比较隐蔽，排查起来很痛苦。
>
> 2. 优秀的异常信息定义真的对问题排查很有帮助，如果我对jna的原理有更多了解，看到 ` Failed to create temporary file for jnidispatch library: java.io.IOException: No such file or directory` z这个异常信息是就可以确定问题了。

解析方法：创建 `java.io.tmpdir` 所指定的目录。



# 2022-01-20

问题描述：使用 tomcat 9.0.54 在 idea 中调试 EomFront，启动失败，异常信息如下:

```
[2022-01-20 14:15:51,703] DEBUG   
     {conn-100000} Preparing Statement:     SELECT DEFAULT_VALUE BM, NAME MC FROM PAD_SYS_PARA     WHERE 1=1           
[2022-01-20 14:15:53,416] ERROR   
     Error calling Connection.prepareStatement:
java.lang.AbstractMethodError: oracle.jdbc.driver.T4CConnection.isValid(I)Z
	at org.apache.tomcat.dbcp.dbcp2.DelegatingConnection.isValid(DelegatingConnection.java:607)
	at org.apache.tomcat.dbcp.dbcp2.PoolableConnection.validate(PoolableConnection.java:379)
	at org.apache.tomcat.dbcp.dbcp2.PoolableConnectionFactory.validateConnection(PoolableConnectionFactory.java:744)
	at org.apache.tomcat.dbcp.dbcp2.BasicDataSource.validateConnectionFactory(BasicDataSource.java:114)
	at org.apache.tomcat.dbcp.dbcp2.BasicDataSource.createPoolableConnectionFactory(BasicDataSource.java:649)
	at org.apache.tomcat.dbcp.dbcp2.BasicDataSource.createDataSource(BasicDataSource.java:532)
	at org.apache.tomcat.dbcp.dbcp2.BasicDataSource.getConnection(BasicDataSource.java:731)
	at org.springframework.jdbc.datasource.DataSourceUtils.doGetConnection(DataSourceUtils.java:111)
	at org.springframework.jdbc.datasource.TransactionAwareDataSourceProxy$TransactionAwareInvocationHandler.invoke(TransactionAwareDataSourceProxy.java:224)
	at com.sun.proxy.$Proxy5.prepareStatement(Unknown Source)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at com.ibatis.common.jdbc.logging.ConnectionLogProxy.invoke(ConnectionLogProxy.java:53)
	at com.sun.proxy.$Proxy6.prepareStatement(Unknown Source)
	at com.ibatis.sqlmap.engine.execution.SqlExecutor.prepareStatement(SqlExecutor.java:497)
	at com.ibatis.sqlmap.engine.execution.SqlExecutor.executeQuery(SqlExecutor.java:175)
	at com.ibatis.sqlmap.engine.mapping.statement.MappedStatement.sqlExecuteQuery(MappedStatement.java:221)
	at com.ibatis.sqlmap.engine.mapping.statement.MappedStatement.executeQueryWithCallback(MappedStatement.java:189)
	at com.ibatis.sqlmap.engine.mapping.statement.MappedStatement.executeQueryForList(MappedStatement.java:139)
	at com.ibatis.sqlmap.engine.impl.SqlMapExecutorDelegate.queryForList(SqlMapExecutorDelegate.java:567)
	at com.ibatis.sqlmap.engine.impl.SqlMapExecutorDelegate.queryForList(SqlMapExecutorDelegate.java:541)
	at com.ibatis.sqlmap.engine.impl.SqlMapSessionImpl.queryForList(SqlMapSessionImpl.java:118)
	at org.springframework.orm.ibatis.SqlMapClientTemplate$3.doInSqlMapClient(SqlMapClientTemplate.java:295)
	at org.springframework.orm.ibatis.SqlMapClientTemplate$3.doInSqlMapClient(SqlMapClientTemplate.java:1)
	at org.springframework.orm.ibatis.SqlMapClientTemplate.execute(SqlMapClientTemplate.java:200)
	at org.springframework.orm.ibatis.SqlMapClientTemplate.queryForList(SqlMapClientTemplate.java:293)
	at com.eom.web.device.common.utils.CommonManager.getSysPara(CommonManager.java:69)
	at com.eom.web.device.common.utils.CommonManager.init(CommonManager.java:34)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeCustomInitMethod(AbstractAutowireCapableBeanFactory.java:1571)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeInitMethods(AbstractAutowireCapableBeanFactory.java:1512)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1442)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:522)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:459)
	at org.springframework.beans.factory.support.AbstractBeanFactory$1.getObject(AbstractBeanFactory.java:294)
	at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:225)
	at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:291)
	at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:193)
	at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:585)
	at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:913)
	at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:464)
	at org.springframework.web.context.ContextLoader.configureAndRefreshWebApplicationContext(ContextLoader.java:381)
	at org.springframework.web.context.ContextLoader.initWebApplicationContext(ContextLoader.java:283)
	at org.springframework.web.context.ContextLoaderListener.contextInitialized(ContextLoaderListener.java:111)
	at org.apache.catalina.core.StandardContext.listenerStart(StandardContext.java:4768)
	at org.apache.catalina.core.StandardContext.startInternal(StandardContext.java:5230)
	at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:183)
	at org.apache.catalina.core.ContainerBase$StartChild.call(ContainerBase.java:1396)
	at org.apache.catalina.core.ContainerBase$StartChild.call(ContainerBase.java:1386)
	at java.util.concurrent.FutureTask.run$$$capture(FutureTask.java:266)
	at java.util.concurrent.FutureTask.run(FutureTask.java)
	at org.apache.tomcat.util.threads.InlineExecutorService.execute(InlineExecutorService.java:75)
	at java.util.concurrent.AbstractExecutorService.submit(AbstractExecutorService.java:134)
	at org.apache.catalina.core.ContainerBase.startInternal(ContainerBase.java:919)
	at org.apache.catalina.core.StandardHost.startInternal(StandardHost.java:835)
	at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:183)
	at org.apache.catalina.core.ContainerBase$StartChild.call(ContainerBase.java:1396)
	at org.apache.catalina.core.ContainerBase$StartChild.call(ContainerBase.java:1386)
	at java.util.concurrent.FutureTask.run$$$capture(FutureTask.java:266)
	at java.util.concurrent.FutureTask.run(FutureTask.java)
	at org.apache.tomcat.util.threads.InlineExecutorService.execute(InlineExecutorService.java:75)
	at java.util.concurrent.AbstractExecutorService.submit(AbstractExecutorService.java:134)
	at org.apache.catalina.core.ContainerBase.startInternal(ContainerBase.java:919)
	at org.apache.catalina.core.StandardEngine.startInternal(StandardEngine.java:263)
	at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:183)
	at org.apache.catalina.core.StandardService.startInternal(StandardService.java:432)
	at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:183)
	at org.apache.catalina.core.StandardServer.startInternal(StandardServer.java:927)
	at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:183)
	at org.apache.catalina.startup.Catalina.start(Catalina.java:772)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.apache.catalina.startup.Bootstrap.start(Bootstrap.java:345)
	at org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:476)
20-Jan-2022 14:15:53.464 严重 [main] org.apache.catalina.core.StandardContext.startInternal 一个或多个listeners启动失败，更多详细信息查看对应的容器日志文件
20-Jan-2022 14:15:53.465 严重 [main] org.apache.catalina.core.StandardContext.startInternal 由于之前的错误，Context[/eomfront]启动失败
```



问题原因：出现这个错误是 oracle jdbc 实现版本的问题，该项目为老式的web项目，不使用maven进行依赖管理，所有依赖从 WEB-INF/lib 目录下加载，该目录下存在两个oracle jdbc 驱动，ojdbc5.jar 和 ojdbc6-11.2.0.4.0-atlassian-hosted.jar，tomcat进程先加载 ojdc5，这个版本不适配 jdk8。

解决方法：

1. 删掉 WEB-INF/lib 目录 ojdbc5.jar,保证 tomcat 可正常使用 ojdbc6-11.2.0.4.0-atlassian-hosted.jar，该版本支持jdk8。
2. ojdbc6-11.2.0.4.0-atlassian-hosted.jar 放到 tomcat 根目录的 lib 目录下，优先使用该 jar 包。

>tomcat jar 包 class 加载顺序：
>
>1. $java_home/lib 目录下的java核心api 
>2. $java_home/lib/ext 目录下的java扩展jar包
>
>3. java -classpath/-Djava.class.path所指的目录下的类与jar包
>
>4. $CATALINA_HOME/common目录下按照文件夹的顺序从上往下依次加载
>
>5. $CATALINA_HOME/server目录下按照文件夹的顺序从上往下依次加载
>
>6. $CATALINA_BASE/shared目录下按照文件夹的顺序从上往下依次加载
>
>7. 我们的项目路径/WEB-INF/classes下的class文件
>
>8. 我们的项目路径/WEB-INF/lib下的jar文件
>
>在同一个文件夹下，jar包是按顺序从上到下依次加载
>
>由ClassLoader的双亲委托模式加载机制我们可以知道，假设两个包名和类名完全相同的class文件不再同一个jar包，如果一个class文件已经被加载java虚拟机里了，那么后面的相同的class文件就不会被加载了。

# 2022-05-10

问题描述：用 Socket 模拟了一个http服务端，服务端启动后，第一次请求客户端可正常收到响应，第二次开始就会出现 `java.net.SocketException: Software caused connection abort: recv failed`，服务端重启之后依然是同样情况。

服务端代码，java Socket API：

```java
public class HttpServer02 {
    public static void main(String[] args) throws IOException{
        ServerSocket serverSocket = new ServerSocket(8802);
        while (true) {
            try {
                final Socket socket = serverSocket.accept();
                new Thread(() -> {
                    service(socket);
                }).start();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }
    
    private static void service(Socket socket) {
        try {
            PrintWriter printWriter = new PrintWriter(socket.getOutputStream(), true);
            printWriter.println("HTTP/1.1 200 OK");
            printWriter.println("Content-Type:text/html;charset=utf-8");
            String body = "hello,nio2";
            printWriter.println("Content-Length:" + body.getBytes().length);
            printWriter.println();
            printWriter.write(body);
            printWriter.close();
            socket.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

客户端代码，okHttp：

```java
public class OkHttp {
    private static OkHttpClient client = new OkHttpClient();
    public static void main(String[] args) {

        Request request = new Request.Builder()
                .addHeader("Connection","close")
                .url("http://127.0.0.1:8802")
                .build();
        try (Response response = client.newCall(request).execute()) {
            String result = response.body().string();
            System.out.println(result);
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }
}
```

异常信息：

```
Exception in thread "main" java.lang.RuntimeException: java.net.SocketException: Software caused connection abort: recv failed
	at client.OkHttp.main(OkHttp.java:23)
Caused by: java.net.SocketException: Software caused connection abort: recv failed
	at java.base/java.net.SocketInputStream.socketRead0(Native Method)
	at java.base/java.net.SocketInputStream.socketRead(SocketInputStream.java:115)
	at java.base/java.net.SocketInputStream.read(SocketInputStream.java:168)
	at java.base/java.net.SocketInputStream.read(SocketInputStream.java:140)
	at okio.InputStreamSource.read(JvmOkio.kt:90)
	at okio.AsyncTimeout$source$1.read(AsyncTimeout.kt:129)
	at okio.RealBufferedSource.indexOf(RealBufferedSource.kt:427)
	at okio.RealBufferedSource.readUtf8LineStrict(RealBufferedSource.kt:320)
	at okhttp3.internal.http1.HeadersReader.readLine(HeadersReader.kt:29)
	at okhttp3.internal.http1.Http1ExchangeCodec.readResponseHeaders(Http1ExchangeCodec.kt:178)
	at okhttp3.internal.connection.Exchange.readResponseHeaders(Exchange.kt:106)
	at okhttp3.internal.http.CallServerInterceptor.intercept(CallServerInterceptor.kt:79)
	at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:109)
	at okhttp3.internal.connection.ConnectInterceptor.intercept(ConnectInterceptor.kt:34)
	at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:109)
	at okhttp3.internal.cache.CacheInterceptor.intercept(CacheInterceptor.kt:95)
	at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:109)
	at okhttp3.internal.http.BridgeInterceptor.intercept(BridgeInterceptor.kt:83)
	at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:109)
	at okhttp3.internal.http.RetryAndFollowUpInterceptor.intercept(RetryAndFollowUpInterceptor.kt:76)
	at okhttp3.internal.http.RealInterceptorChain.proceed(RealInterceptorChain.kt:109)
	at okhttp3.internal.connection.RealCall.getResponseWithInterceptorChain$okhttp(RealCall.kt:201)
	at okhttp3.internal.connection.RealCall.execute(RealCall.kt:154)
	at client.OkHttp.main(OkHttp.java:19)
```

客户端代码，Apache HttpClient：

```java
public class ApacheHttpClient {
    public static void main(String[] args) {
        HttpGet httpGet = new HttpGet("http://127.0.0.1:8802");
        try(CloseableHttpClient httpclient = HttpClients.createDefault();
            CloseableHttpResponse response = httpclient.execute(httpGet)) {
            System.out.println(response.getStatusLine());
            HttpEntity entity = response.getEntity();
            String resp = EntityUtils.toString(entity);
            System.out.println(resp);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

异常信息：

```
5月 10, 2022 2:30:56 下午 org.apache.http.impl.execchain.RetryExec execute
信息: I/O exception (java.net.SocketException) caught when processing request to {}->http://127.0.0.1:8802: Software caused connection abort: recv failed
5月 10, 2022 2:30:56 下午 org.apache.http.impl.execchain.RetryExec execute
信息: Retrying request to {}->http://127.0.0.1:8802
HTTP/1.1 200 OK
hello,nio2
```

问题原因：直接原因是，服务端收到请求后的处理方法中，没有用socket的输入流将客户端的请求输入读取出来消费掉。

但是为什么，socket关闭后，上一次请求的inputstream还会对下一次请求造成影响，导致下一次请求出现`connection abort: recv failed` ?

为什么用 Apache HttpClient 时，通过它的默认 RetryExec 机制，出现一次上述异常后，重试能执行成功？

解决方法：服务端增加获取socket输入流消费客户端请求输入的代码，改造后如下

```java
public class HttpServer02 {
    public static void main(String[] args) throws IOException{
        ServerSocket serverSocket = new ServerSocket(8802);
        while (true) {
            try {
                final Socket socket = serverSocket.accept();
                new Thread(() -> {
                    service(socket);
                }).start();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }
    
    private static void service(Socket socket) {
        try {
            BufferedReader in = new BufferedReader(new InputStreamReader(socket.getInputStream()));
            String line;
            while ((line = in.readLine()) != null) {
                if (line.length() == 0) {
                    break;
                }
                System.out.println(LocalDateTime.now() +"\t"+ line);
            }

            PrintWriter printWriter = new PrintWriter(socket.getOutputStream(), true);
            printWriter.println("HTTP/1.1 200 OK");
            printWriter.println("Content-Type:text/html;charset=utf-8");
            String body = "hello,nio2";
            printWriter.println("Content-Length:" + body.getBytes().length);
            printWriter.println();
            printWriter.write(body);
            printWriter.flush();

            in.close();
            printWriter.close();
            socket.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

